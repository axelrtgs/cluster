# yaml-language-server: $schema=https://kubernetes-schemas.zinn.ca/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: authelia
    namespace: authelia
spec:
    interval: 15m
    chart:
        spec:
            chart: authelia
            version: 27.1.5
            sourceRef:
                kind: HelmRepository
                name: truecharts
                namespace: flux-system
    releaseName: authelia
    values:
        TZ: America/Montreal
        domain: ${BASE_DOMAIN}
        authelia:
            server:
                buffers:
                    read: 8192
                    write: 8192
            session:
                expiration: 1h
                inactivity: 5m
                name: authelia_session
                remember_me: 5M
                same_site: lax
                cookies:
                    - domain: auth.${BASE_DOMAIN}
                      authelia_url: https://auth.${BASE_DOMAIN}
            totp:
                issuer: ${BASE_DOMAIN}
                period: 30
                skew: 1
            webauthn:
                disable: false
                enable_passkey_login: false
            notifier:
                smtp:
                    address: ${SMTP_HOST}:${SMTP_PORT}
                    username: ${SMTP_USER}
                    password: ${SMTP_PASSWORD}
                    sender: ${SMTP_FROM}
                    startup_check_address: ${SMTP_FROM}
            identity_providers:
                oidc:
                    claims_policies:
                        default:
                            id_token:
                                - groups
                                - email
                                - preferred_username
                                - name
                    hmac_secret: ${AUTHELIA_OIDC_HMAC_SECRET}
                    jwks:
                        - key: ENC[AES256_GCM,data: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,iv:SjcNO4AFzSckbeorG9O5PLW1Dd7pKi/uPX40WW5n2KY=,tag:WG/HZaHNV5CePMzOv8pxWQ==,type:str]
                    clients:
                        - client_id: ${AUTHELIA_CLOUDFLARE_ID}
                          client_name: Cloudflare Access
                          client_secret: ${AUTHELIA_CLOUDFLARE_SECRET}
                          consent_mode: implicit
                          redirect_uris:
                            - ${AUTHELIA_CLOUDFLARE_REDIRECT_URI}
                          require_pkce: true
                          claims_policy: default
                        - client_id: ${AUTHELIA_MEALIE_ID}
                          client_name: Mealie
                          client_secret: ${AUTHELIA_MEALIE_SECRET_DIGEST}
                          consent_mode: implicit
                          redirect_uris:
                            - https://mealie.${BASE_DOMAIN}/login
                          require_pkce: true
            access_control:
                default_policy: two_factor
                rules:
                    - domain:
                        - auth.${BASE_DOMAIN}
                      domain_regex: []
                      networks: []
                      policy: bypass
                      resources: []
                      subject: []
                    - domain:
                        - ${BASE_DOMAIN}
                      domain_regex: []
                      networks: []
                      policy: two_factor
                      resources: []
                      subject:
                        - group:users
            authentication_backend:
                password_reset:
                    disable: true
                password_change:
                    disable: false
                ldap:
                    additional_groups_dn: OU=Groups
                    additional_users_dn: OU=people
                    base_dn: ${LLDAP_LDAP_BASE_DN}
                    attributes:
                        group_name: cn
                        display_name: displayName
                        username: uid
                        mail: mail
                    groups_filter: (member={dn})
                    implementation: custom
                    password: ${LLDAP_LDAP_USER_PASS}
                    start_tls: false
                    timeout: 5s
                    tls:
                        minimum_version: TLS1.2
                        server_name: ""
                        skip_verify: false
                    address: ldap://lldap-ldap.lldap.svc.cluster.local:3890
                    user: uid=ldap,ou=people,${LLDAP_LDAP_BASE_DN}
                    users_filter: (&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=person))
                refresh_interval: 5m
        cnpg:
            main:
                backups:
                    credentials: s3
                    enabled: true
                    retentionPolicy: ""
                    revision: "1"
                cluster:
                    instances: 1
                    singleNode: true
                database: authelia
                enabled: true
                hibernate: false
                mode: recovery
                monitoring:
                    disableDefaultQueries: false
                    enablePodMonitor: true
                password: PLACEHOLDERPASSWORD
                pgVersion: 16
                pooler:
                    enabled: false
                recovery:
                    enabled: true
                    revision: ""
                    credentials: s3
                user: authelia
        credentials:
            s3:
                type: s3
                url: ${S3URL}
                bucket: ${S3BUCKET}
                accessKey: ${S3ID}
                secretKey: ${S3KEY}
                encrKey: ${S3ENCRKEY}
        ingress:
            main:
                enabled: true
                hosts:
                    - host: auth.${BASE_DOMAIN}
                      paths:
                        - path: /
                          pathType: Prefix
                integrations:
                    certManager:
                        certificateIssuer: domain-0-le-prod
                        enabled: true
                    homepage:
                        enabled: false
                    traefik:
                        allowCors: false
                        enabled: true
                        entrypoints:
                            - websecure
                required: true
        persistence:
            config:
                enabled: true
                mountPath: /config
                readOnly: false
                volsync:
                    - credentials: s3
                      dest:
                        enabled: true
                      name: s3
                      src:
                        enabled: true
                      type: restic
        workload:
            main:
                podSpec:
                    containers:
                        main:
                            env:
                                AUTHELIA_SESSION_SECRET: ${AUTHELIA_SESSION_ENCRYPTION_KEY}
                                AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET: ${AUTHELIA_JWT_TOKEN}
                                AUTHELIA_STORAGE_ENCRYPTION_KEY: ${AUTHELIA_ENCRYPTION_KEY}
sops:
    shamir_threshold: 3
    age:
        - recipient: age1fxr2mjtfjy0t755p2tmemttj4ft70sgffhv0ax99v6agutqh6d6shh439a
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBHaGw2M0lIQ3c1eTNtSHhI
            Zm1HK3NLRmllZml6Uk5qU3RtVExBRit6RWtBCklySUdTcFJ4NFRkOVN6enBNZEdm
            cEhzZkhLL09CVFFqYXNPSkVBWXdnTjQKLS0tIE9GSm80ZU5jZG8rRWovd1RQOU5u
            TDRyU1N2YTI5TmVSdVVJRlRTTWlZLzAK1lTxb0A4aLq27+nHOsrB4o26WcdBSZJQ
            lYXrg16hwBpFvdI6wktAWVGXD2QStY4cO81a2DlRV2hCcAhso+hsvw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-04-16T20:10:49Z"
    mac: ENC[AES256_GCM,data:LCSBZPIQviYGl89FtdSNV7AyM/6FPT65+bhiarqghtKXWh5ayCBLeFVG9m4yAGhg6+PXVTSveXW9Sg3EYrAzw7CXcKOi1d4k87jahyw4Nch2eIITl8WVyx1qBVYBbMBYrVvfxTyMx8JJKmbZ7tJ0+jU/FHZdL8hsJLgvmAT3Ack=,iv:bMK1xX9bMnQSf2cNIAeXSKzq8ZsLTUqeVUqKv6Fei6k=,tag:GWOkb7hGQUCWujBEpnzMaQ==,type:str]
    encrypted_regex: jwks
    version: 3.10.1
