# yaml-language-server: $schema=https://kubernetes-schemas.zinn.ca/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: authelia
    namespace: authelia
spec:
    interval: 15m
    chart:
        spec:
            chart: authelia
            version: 27.1.5
            sourceRef:
                kind: HelmRepository
                name: truecharts
                namespace: flux-system
    releaseName: authelia
    values:
        TZ: America/Montreal
        domain: ${BASE_DOMAIN}
        authelia:
            server:
                buffers:
                    read: 8192
                    write: 8192
            session:
                expiration: 1h
                inactivity: 5m
                name: authelia_session
                remember_me: 5M
                same_site: lax
                cookies:
                    - domain: auth.${BASE_DOMAIN}
                      authelia_url: https://auth.${BASE_DOMAIN}
            totp:
                issuer: ${BASE_DOMAIN}
                period: 30
                skew: 1
            webauthn:
                disable: false
                enable_passkey_login: false
            notifier:
                smtp:
                    address: ${SMTP_HOST}:${SMTP_PORT}
                    username: ${SMTP_USER}
                    password: ${SMTP_PASSWORD}
                    sender: ${SMTP_FROM}
                    startup_check_address: ${SMTP_FROM}
            identity_providers:
                oidc:
                    claims_policies:
                        default:
                            id_token:
                                - groups
                                - email
                                - preferred_username
                                - name
                    hmac_secret: ${AUTHELIA_OIDC_HMAC_SECRET}
                    jwks:
                        - key: ENC[AES256_GCM,data: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,iv:RYvl4GwQSfU+bqum7hIvW+BKTuL+WszH7c157pLlrgw=,tag:gHMLHLfVrmUNEVGOtf1hjg==,type:str]
                    clients:
                        - client_id: ${AUTHELIA_CLOUDFLARE_ID}
                          client_name: Cloudflare Access
                          client_secret: ${AUTHELIA_CLOUDFLARE_SECRET}
                          consent_mode: implicit
                          redirect_uris:
                            - ${AUTHELIA_CLOUDFLARE_REDIRECT_URI}
                          require_pkce: true
                          claims_policy: default
                        - client_id: ${AUTHELIA_MEALIE_ID}
                          client_name: Mealie
                          client_secret: ${AUTHELIA_MEALIE_SECRET_DIGEST}
                          consent_mode: implicit
                          redirect_uris:
                            - https://mealie.${BASE_DOMAIN}/login
                          require_pkce: true
            access_control:
                default_policy: two_factor
                rules:
                    - domain:
                        - auth.${BASE_DOMAIN}
                      domain_regex: []
                      networks: []
                      policy: bypass
                      resources: []
                      subject: []
                    - domain:
                        - ${BASE_DOMAIN}
                      domain_regex: []
                      networks: []
                      policy: two_factor
                      resources: []
                      subject:
                        - group:users
            authentication_backend:
                password_reset:
                    disable: true
                password_change:
                    disable: false
                ldap:
                    additional_groups_dn: OU=Groups
                    additional_users_dn: OU=people
                    base_dn: ${LLDAP_LDAP_BASE_DN}
                    attributes:
                        group_name: cn
                        display_name: displayName
                        username: uid
                        mail: mail
                    groups_filter: (member={dn})
                    implementation: custom
                    password: ${LLDAP_LDAP_USER_PASS}
                    start_tls: false
                    timeout: 5s
                    tls:
                        minimum_version: TLS1.2
                        server_name: ""
                        skip_verify: false
                    address: ldap://lldap-ldap.lldap.svc.cluster.local:3890
                    user: uid=ldap,ou=people,${LLDAP_LDAP_BASE_DN}
                    users_filter: (&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=person))
                refresh_interval: 5m
        cnpg:
            main:
                backups:
                    credentials: s3
                    enabled: true
                    retentionPolicy: ""
                    revision: "1"
                cluster:
                    instances: 1
                    singleNode: true
                database: authelia
                enabled: true
                hibernate: false
                mode: recovery
                monitoring:
                    disableDefaultQueries: false
                    enablePodMonitor: true
                password: PLACEHOLDERPASSWORD
                pgVersion: 16
                pooler:
                    enabled: false
                recovery:
                    enabled: true
                    revision: ""
                    credentials: s3
                user: authelia
        credentials:
            s3:
                type: s3
                url: ${S3URL}
                bucket: ${S3BUCKET}
                accessKey: ${S3ID}
                secretKey: ${S3KEY}
                encrKey: ${S3ENCRKEY}
        ingress:
            main:
                enabled: true
                ingressClassName: external
                hosts:
                    - host: auth.${BASE_DOMAIN}
                      paths:
                        - path: /
                          pathType: Prefix
                integrations:
                    certManager:
                        certificateIssuer: domain-0-le-prod
                        enabled: true
                required: true
        persistence:
            config:
                enabled: true
                mountPath: /config
                readOnly: false
                volsync:
                    - credentials: s3
                      dest:
                        enabled: true
                      name: s3
                      src:
                        enabled: true
                      type: restic
        workload:
            main:
                podSpec:
                    containers:
                        main:
                            env:
                                AUTHELIA_SESSION_SECRET: ${AUTHELIA_SESSION_ENCRYPTION_KEY}
                                AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET: ${AUTHELIA_JWT_TOKEN}
                                AUTHELIA_STORAGE_ENCRYPTION_KEY: ${AUTHELIA_ENCRYPTION_KEY}
sops:
    shamir_threshold: 3
    age:
        - recipient: age1fxr2mjtfjy0t755p2tmemttj4ft70sgffhv0ax99v6agutqh6d6shh439a
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBFK1ljMzlQTWlDYW1oY0VX
            L1orOVB3RnJxSDJPOURqQ3NYRUZpdk13MTJrCnlUUC9wUzdpMWxyaG9DcElkZ3lO
            QVU5K1U0d1lDZDA2QWZkWGVyZFVVeFUKLS0tIG1mTkhJVmUzb3dpWG5hdmxHTTJT
            Q2pZdEVxbStsVG0xbkNwbHNrR1RNbGsKj8Zmo/jzpZHc0ZbPlxaBLvPs8RZWMoTe
            KI4K5qdKvNgpiQw2g4wsdlWzn4+tXT/Roz/DPFlZQhjUHkXPlqQ5nQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-04-17T00:37:30Z"
    mac: ENC[AES256_GCM,data:hLwB1H0S4dD22G3oJNZUtZiyWINBUJeXqztLtAYIvBFEl51ut4P9PMuLYWpqyPr97IX67E9yY1yopwFelJpkXU4bzYyZJ6XlHWSmYVSw067GlX+D1k+iFt0MJTNg6eMwC6zkqpHTpbYx6vpMIXx4VZIo98zeg1PpU4JvgomPPuw=,iv:5IS9v6rYx580aZtwnutxCqJ5iKxBEvAc/7g7khlWVGI=,tag:VxpkVP73yzSfNVEOQ2OQQw==,type:str]
    encrypted_regex: jwks
    version: 3.10.1
