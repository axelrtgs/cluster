# yaml-language-server: $schema=https://kubernetes-schemas.zinn.ca/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: authelia
    namespace: authelia
spec:
    interval: 15m
    chart:
        spec:
            chart: authelia
            version: 27.1.5
            sourceRef:
                kind: HelmRepository
                name: truecharts
                namespace: flux-system
    releaseName: authelia
    values:
        TZ: America/Montreal
        domain: ${BASE_DOMAIN}
        authelia:
            server:
                buffers:
                    read: 8192
                    write: 8192
            session:
                expiration: 1h
                inactivity: 5m
                name: authelia_session
                remember_me: 5M
                same_site: lax
                cookies:
                    - domain: auth.${BASE_DOMAIN}
                      authelia_url: https://auth.${BASE_DOMAIN}
            totp:
                issuer: ${BASE_DOMAIN}
                period: 30
                skew: 1
            webauthn:
                disable: false
                enable_passkey_login: false
            notifier:
                smtp:
                    address: ${SMTP_HOST}:${SMTP_PORT}
                    username: ${SMTP_USER}
                    password: ${SMTP_PASSWORD}
                    sender: ${SMTP_FROM}
                    startup_check_address: ${SMTP_FROM}
            identity_providers:
                oidc:
                    claims_policies:
                        default:
                            id_token:
                                - groups
                                - email
                                - preferred_username
                                - name
                    hmac_secret: ${AUTHELIA_OIDC_HMAC_SECRET}
                    jwks:
                        - key: ENC[AES256_GCM,data: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,iv:xgIt3bHAtqgRlgCDlI5GqDSP5zg6l/AMKEYMRlHcbHQ=,tag:DubdVdqVwDfKexVkqKi31A==,type:str]
                    clients:
                        - client_id: ${AUTHELIA_CLOUDFLARE_ID}
                          client_name: Cloudflare Access
                          client_secret: ${AUTHELIA_CLOUDFLARE_SECRET}
                          consent_mode: implicit
                          redirect_uris:
                            - ${AUTHELIA_CLOUDFLARE_REDIRECT_URI}
                          require_pkce: true
                          claims_policy: default
                        - client_id: ${AUTHELIA_MEALIE_ID}
                          client_name: Mealie
                          client_secret: ${AUTHELIA_MEALIE_SECRET_DIGEST}
                          consent_mode: implicit
                          redirect_uris:
                            - https://mealie.${BASE_DOMAIN}/login
                          require_pkce: true
            access_control:
                default_policy: two_factor
                rules:
                    - domain:
                        - auth.${BASE_DOMAIN}
                      domain_regex: []
                      networks: []
                      policy: bypass
                      resources: []
                      subject: []
                    - domain:
                        - ${BASE_DOMAIN}
                      domain_regex: []
                      networks: []
                      policy: two_factor
                      resources: []
                      subject:
                        - group:users
            authentication_backend:
                password_reset:
                    disable: true
                password_change:
                    disable: false
                ldap:
                    additional_groups_dn: OU=Groups
                    additional_users_dn: OU=people
                    base_dn: ${LLDAP_LDAP_BASE_DN}
                    attributes:
                        group_name: cn
                        display_name: displayName
                        username: uid
                        mail: mail
                    groups_filter: (member={dn})
                    implementation: custom
                    password: ${LLDAP_LDAP_USER_PASS}
                    start_tls: false
                    timeout: 5s
                    tls:
                        minimum_version: TLS1.2
                        server_name: ""
                        skip_verify: false
                    address: ldap://lldap-ldap.lldap.svc.cluster.local:3890
                    user: uid=ldap,ou=people,${LLDAP_LDAP_BASE_DN}
                    users_filter: (&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=person))
                refresh_interval: 5m
        cnpg:
            main:
                backups:
                    credentials: s3
                    enabled: true
                    retentionPolicy: ""
                    revision: "1"
                cluster:
                    instances: 1
                    singleNode: true
                database: authelia
                enabled: true
                hibernate: false
                mode: recovery
                monitoring:
                    disableDefaultQueries: false
                    enablePodMonitor: true
                password: PLACEHOLDERPASSWORD
                pgVersion: 16
                pooler:
                    enabled: false
                recovery:
                    enabled: true
                    revision: ""
                    credentials: s3
                user: authelia
        credentials:
            s3:
                type: s3
                url: ${S3URL}
                bucket: ${S3BUCKET}
                accessKey: ${S3ID}
                secretKey: ${S3KEY}
                encrKey: ${S3ENCRKEY}
        ingress:
            main:
                enabled: true
                ingressClassName: external
                hosts:
                    - host: auth.${BASE_DOMAIN}
                      paths:
                        - path: /
                          pathType: Prefix
                integrations:
                    certManager:
                        certificateIssuer: domain-0-le-prod
                        enabled: true
                    homepage:
                        enabled: false
                required: true
        persistence:
            config:
                enabled: true
                mountPath: /config
                readOnly: false
                volsync:
                    - credentials: s3
                      dest:
                        enabled: true
                      name: s3
                      src:
                        enabled: true
                      type: restic
        workload:
            main:
                podSpec:
                    containers:
                        main:
                            env:
                                AUTHELIA_SESSION_SECRET: ${AUTHELIA_SESSION_ENCRYPTION_KEY}
                                AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET: ${AUTHELIA_JWT_TOKEN}
                                AUTHELIA_STORAGE_ENCRYPTION_KEY: ${AUTHELIA_ENCRYPTION_KEY}
sops:
    shamir_threshold: 3
    age:
        - recipient: age1fxr2mjtfjy0t755p2tmemttj4ft70sgffhv0ax99v6agutqh6d6shh439a
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA1YXprNjQrcmZQeVlLNm9V
            ZTIvNzdUQVBaMFRuOWcwN01tVDI2VHRmbmxRClJpSmFqdS80QUtCRStGYU0wdVh0
            SHBiOEg4Ri9QMlFnNDI3NU5TQjNEQjAKLS0tIHRwcUNacnR5bXhSelE1ZFRjeUZI
            Z1RaUDBqR3dEZFNlQ2MyQ2JvKytORUkK00G2mYwbIAA7O+r8SHkq3HY93szLXbJ9
            FNx4QOwBHwsBR7RhPZSY0ppxUDaBhRFY4Usu1GhFMd/IUcXl1ZuELg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-04-16T23:48:26Z"
    mac: ENC[AES256_GCM,data:5Rb+fOzDU4BdPyFklLgwrsysM72g/i/8BmFy7XAMEXEBnT+dE1yeua5Hs+fuFoiEvGo3FF6I2AH6qWvQWq6PPmznZrQGFRUGW/qBCCkCmpSHrw9AkAeaKYg2N7Rs6V9riT4oHs2IHPshBFsDzQNa0lbcuZre3sVbJvQMt9MfCOo=,iv:Fpokqe6Hfo29pCx5BtMraBX6l7ulR2xSuxwzB3kjT7s=,tag:7f4jsIlWrILvYYdRsfelwQ==,type:str]
    encrypted_regex: jwks
    version: 3.10.1
