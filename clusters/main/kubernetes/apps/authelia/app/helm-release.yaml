# yaml-language-server: $schema=https://kubernetes-schemas.zinn.ca/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: authelia
    namespace: authelia
spec:
    interval: 15m
    chart:
        spec:
            chart: authelia
            version: 27.1.5
            sourceRef:
                kind: HelmRepository
                name: truecharts
                namespace: flux-system
    releaseName: authelia
    values:
        TZ: America/Montreal
        domain: ${BASE_DOMAIN}
        authelia:
            server:
                buffers:
                    read: 8192
                    write: 8192
            session:
                expiration: 1h
                inactivity: 5m
                name: authelia_session
                remember_me: 5M
                same_site: lax
                cookies:
                    - domain: auth.${BASE_DOMAIN}
                      authelia_url: https://auth.${BASE_DOMAIN}
            totp:
                issuer: ${BASE_DOMAIN}
                period: 30
                skew: 1
            webauthn:
                disable: false
                enable_passkey_login: false
            notifier:
                smtp:
                    address: ${SMTP_HOST}:${SMTP_PORT}
                    username: ${SMTP_USER}
                    password: ${SMTP_PASSWORD}
                    sender: ${SMTP_FROM}
                    startup_check_address: ${SMTP_FROM}
            identity_providers:
                oidc:
                    claims_policies:
                        default:
                            id_token:
                                - groups
                                - email
                                - preferred_username
                                - name
                    hmac_secret: ${AUTHELIA_OIDC_HMAC_SECRET}
                    jwks:
                        - key: ENC[AES256_GCM,data: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,iv:K/+dYMD2kCImcOi0/b69LViZ+DFVtRV3W7sdgTswdoE=,tag:YXN8H59EkGYcaYfLKsScfw==,type:str]
                    clients:
                        - client_id: ${AUTHELIA_CLOUDFLARE_ID}
                          client_name: Cloudflare Access
                          client_secret: ${AUTHELIA_CLOUDFLARE_SECRET}
                          consent_mode: implicit
                          redirect_uris:
                            - ${AUTHELIA_CLOUDFLARE_REDIRECT_URI}
                          require_pkce: true
                          claims_policy: default
                        - client_id: ${AUTHELIA_MEALIE_ID}
                          client_name: Mealie
                          client_secret: ${AUTHELIA_MEALIE_SECRET_DIGEST}
                          consent_mode: implicit
                          redirect_uris:
                            - https://mealie.${BASE_DOMAIN}/login
                          require_pkce: true
            access_control:
                default_policy: two_factor
                rules:
                    - domain:
                        - auth.${BASE_DOMAIN}
                      domain_regex: []
                      networks: []
                      policy: bypass
                      resources: []
                      subject: []
                    - domain:
                        - ${BASE_DOMAIN}
                      domain_regex: []
                      networks: []
                      policy: two_factor
                      resources: []
                      subject:
                        - group:users
            authentication_backend:
                password_reset:
                    disable: true
                password_change:
                    disable: false
                ldap:
                    additional_groups_dn: OU=Groups
                    additional_users_dn: OU=people
                    base_dn: ${LLDAP_LDAP_BASE_DN}
                    attributes:
                        group_name: cn
                        display_name: displayName
                        username: uid
                        mail: mail
                    groups_filter: (member={dn})
                    implementation: custom
                    password: ${LLDAP_LDAP_USER_PASS}
                    start_tls: false
                    timeout: 5s
                    tls:
                        minimum_version: TLS1.2
                        server_name: ""
                        skip_verify: false
                    address: ldap://lldap-ldap.lldap.svc.cluster.local:3890
                    user: uid=ldap,ou=people,${LLDAP_LDAP_BASE_DN}
                    users_filter: (&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=person))
                refresh_interval: 5m
        cnpg:
            main:
                backups:
                    credentials: s3
                    enabled: true
                    retentionPolicy: ""
                    revision: "1"
                cluster:
                    instances: 1
                    singleNode: true
                database: authelia
                enabled: true
                hibernate: false
                mode: recovery
                monitoring:
                    disableDefaultQueries: false
                    enablePodMonitor: true
                password: PLACEHOLDERPASSWORD
                pgVersion: 16
                pooler:
                    enabled: false
                recovery:
                    enabled: true
                    revision: ""
                    credentials: s3
                user: authelia
        credentials:
            s3:
                type: s3
                url: ${S3URL}
                bucket: ${S3BUCKET}
                accessKey: ${S3ID}
                secretKey: ${S3KEY}
                encrKey: ${S3ENCRKEY}
        ingress:
            main:
                enabled: true
                ingressClassName: external
                hosts:
                    - host: auth.${BASE_DOMAIN}
                      paths:
                        - path: /
                          pathType: Prefix
                integrations:
                    certManager:
                        certificateIssuer: domain-0-le-prod
                        enabled: true
                    homepage:
                        enabled: false
                required: true
        persistence:
            config:
                enabled: true
                mountPath: /config
                readOnly: false
                volsync:
                    - credentials: s3
                      dest:
                        enabled: true
                      name: s3
                      src:
                        enabled: true
                      type: restic
        workload:
            main:
                podSpec:
                    containers:
                        main:
                            env:
                                AUTHELIA_SESSION_SECRET: ${AUTHELIA_SESSION_ENCRYPTION_KEY}
                                AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET: ${AUTHELIA_JWT_TOKEN}
                                AUTHELIA_STORAGE_ENCRYPTION_KEY: ${AUTHELIA_ENCRYPTION_KEY}
sops:
    shamir_threshold: 3
    age:
        - recipient: age1fxr2mjtfjy0t755p2tmemttj4ft70sgffhv0ax99v6agutqh6d6shh439a
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBDK0JLYWNGWi94T0xyUy9S
            ZHBMZWx0bWFQZHRPb1dMU0xlTFBLUEx2TUJvClMrL09SaTRWNi9nMUNiajV6VnV4
            VTZCZU4wYVgrT3JYcEdkRmE3dW9DRTQKLS0tIDdjODdaTU1QajBqZmlhWHNDYjEv
            MDN5OGczWXNWRlNCdU96U0xYSGZZbUkK1DpXwxWbB2hKzqCLSUwY0fCwXHvBKpzi
            KNqbLJYhD1gPhgRz28yDn0Jh4j+VMYeyeSSZJurLXPK311yUBzSi4g==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-04-16T23:32:07Z"
    mac: ENC[AES256_GCM,data:Z8EPRC9cuf8pbW91vjPyp8MZy+cgrQYNjnMQGYl2eHyUNZe8B1KasrdzekWKuc0UW9q4YXGaQLcmn9+0OxXQgDuJQ1zdNPpt7w5x51zdvdwytaOp0spvwVs+KY8SO7/w6FRtn7j/PjIfyLyCT2etTo+Ys63bnw7Sn+5wpqPVwhs=,iv:h1DjEiAofxEb2SNN7CVlwk/PTIkmpAUl7AGQ9tMwgMU=,tag:5JCW2hvss+FUeLMaGMWuHQ==,type:str]
    encrypted_regex: jwks
    version: 3.10.1
